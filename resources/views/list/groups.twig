<div class="transaction-filter-bar" style="padding:6px 8px;border-bottom:1px solid rgba(128,128,128,0.25);display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
    <button type="button" class="btn btn-default btn-sm" id="toggle-filters">
        <span class="fa fa-filter"></span> {{ 'Filters'|_ }}
    </button>
    <div style="flex:1;min-width:200px;position:relative;">
        <input type="text" class="form-control input-sm" id="filter_query"
               placeholder="Advanced: description_contains:amazon amount_more:50 ..."
               value="{{ filters.filter_query|default('') }}"
               style="padding-right:28px;">
        <a href="#" data-toggle="modal" data-target="#filterHelpModal"
           style="position:absolute;right:6px;top:50%;transform:translateY(-50%);opacity:0.5;font-size:14px;line-height:1;"
           title="Filter reference"><span class="fa fa-question-circle"></span></a>
    </div>
    <button type="button" class="btn btn-info btn-sm" id="apply-filters">
        <span class="fa fa-search"></span> Apply
    </button>
    <button type="button" class="btn btn-default btn-sm" id="clear-filters">
        <span class="fa fa-times"></span> Clear
    </button>
</div>
<table class="table table-condensed table-hover table-responsive">
    <thead>
    <tr>
        {% if showCategory or showBudget %}
            <td colspan="7" class="no-margin-pagination">
                {{ groups.links('pagination.bootstrap-4')|raw }}
                {% if groups.total() > 0 %}
                    <span class="text-muted small" style="margin-left:10px;">Showing {{ groups.firstItem() }}–{{ groups.lastItem() }} of {{ groups.total() }}</span>
                    {% include 'partials.per-page-toggle' %}
                {% endif %}
            </td>
        {% else %}
            <td colspan="6" class="no-margin-pagination">
                {{ groups.links('pagination.bootstrap-4')|raw }}
                {% if groups.total() > 0 %}
                    <span class="text-muted small" style="margin-left:10px;">Showing {{ groups.firstItem() }}–{{ groups.lastItem() }} of {{ groups.total() }}</span>
                    {% include 'partials.per-page-toggle' %}
                {% endif %}
            </td>
        {% endif %}
        <td colspan="1" class="hidden-xs">
            <!-- Single button -->
            <div class="btn-group btn-group-xs action-menu pull-right" style="display: none;">
                <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false">
                    {{ 'actions'|_ }} <span class="caret"></span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right">
                    <li><a href="#" class="mass-edit"><span class="fa fa-fw fa-pencil"></span>
                            <span class="txt">{{ 'mass_edit'|_ }}</span></a></li>
                    <li><a href="#" class="bulk-edit"><span class="fa fa-fw fa-pencil-square-o"></span>
                            <span class="txt">{{ 'bulk_edit'|_ }}</span></a></li>
                    <li><a href="#" class="mass-delete"><span class="fa fa-fw fa-trash"></span>
                            <span class="txt">{{ 'mass_delete'|_ }}</span></a></li>
                </ul>
            </div>
        </td>
        <td colspan="1" class="hidden-xs">
            <div class="pull-right">
                <input id="list_ALL" value="1" name="select-all" type="checkbox" class="select-all form-check-inline"/>
            </div>
        </td>
    </tr>
    <tr>
        <th class="hidden-xs">&nbsp;</th>
        <th>{{ trans('list.description') }}</th>
        <th>{{ trans('list.amount') }}</th>
        {% if fireflyiiiconfig('use_running_balance', true) %}
        <th>{{ trans('list.running_balance') }}</th>
        {% endif %}
        <th>{{ trans('list.date') }}</th>
        <th>{{ trans('list.source_account') }}</th>
        <th>{{ trans('list.destination_account') }}</th>
        {% if showCategory %}
            <th class="hidden-xs">{{ trans('list.category') }}</th>
        {% endif %}
        {% if showBudget %}
            <th class="hidden-xs">{{ trans('list.budget') }}</th>
        {% endif %}
        <th class="hidden-xs">&nbsp;</th><!-- actions -->
        <th class="hidden-xs">&nbsp;</th><!-- checkbox -->
    </tr>
    <tr class="filter-row" style="display:none;background:rgba(128,128,128,0.08);">
        <td class="hidden-xs">&nbsp;</td>
        <td>
            <input type="text" class="form-control input-sm filter-input" id="filter_description"
                   placeholder="{{ trans('list.description') }}" value="{{ filters.filter_description|default('') }}">
        </td>
        <td style="min-width:160px;">
            <div style="display:flex;gap:2px;">
                <input type="number" step="0.01" class="form-control input-sm filter-input" id="filter_amount_min"
                       placeholder="Min" value="{{ filters.filter_amount_min|default('') }}" style="width:50%;">
                <input type="number" step="0.01" class="form-control input-sm filter-input" id="filter_amount_max"
                       placeholder="Max" value="{{ filters.filter_amount_max|default('') }}" style="width:50%;">
            </div>
        </td>
        {% if fireflyiiiconfig('use_running_balance', true) %}
        <td>&nbsp;</td>
        {% endif %}
        <td style="min-width:180px;">
            <div style="display:flex;gap:2px;">
                <input type="date" class="form-control input-sm filter-input" id="filter_date_from"
                       value="{{ filters.filter_date_from|default('') }}" style="width:50%;">
                <input type="date" class="form-control input-sm filter-input" id="filter_date_to"
                       value="{{ filters.filter_date_to|default('') }}" style="width:50%;">
            </div>
        </td>
        <td>
            <input type="text" class="form-control input-sm filter-input" id="filter_source"
                   placeholder="{{ trans('list.source_account') }}" value="{{ filters.filter_source|default('') }}">
        </td>
        <td>
            <input type="text" class="form-control input-sm filter-input" id="filter_destination"
                   placeholder="{{ trans('list.destination_account') }}" value="{{ filters.filter_destination|default('') }}">
        </td>
        {% if showCategory %}
            <td class="hidden-xs">
                <input type="text" class="form-control input-sm filter-input" id="filter_category"
                       placeholder="{{ trans('list.category') }}" value="{{ filters.filter_category|default('') }}">
            </td>
        {% endif %}
        {% if showBudget %}
            <td class="hidden-xs">
                <input type="text" class="form-control input-sm filter-input" id="filter_budget"
                       placeholder="{{ trans('list.budget') }}" value="{{ filters.filter_budget|default('') }}">
            </td>
        {% endif %}
        <td class="hidden-xs">&nbsp;</td>
        <td class="hidden-xs">&nbsp;</td>
    </tr>
    </thead>
    <tbody>
    {% for group in groups %}
        {% if group.count > 1 %}
            <tr style="border-top:1px #aaa solid;">
                <td colspan="2" style="border-top:1px #aaa solid;">
                    <small><strong>
                            <a href="{{ route('transactions.show', [group.id]) }}"
                               title="{{ group.title }}">{{ group.title }}</a>
                        </strong></small>
                </td>
                <td colspan="1" style="text-align:right;border-top:1px #aaa solid;">
                    {% for sum in group.sums %}
                        {% if group.transaction_type == 'Deposit' %}
                            {{ formatAmountBySymbol(sum.amount*-1, sum.currency_symbol, sum.currency_decimal_places) }}
                            {% if convertToPrimary and 0 != sum.pc_amount %}
                                (~ {{ formatAmountBySymbol(sum.pc_amount*-1, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                            {% if loop.index != group.sums|length %},{% endif %}

                        {% elseif group.transaction_type == 'Transfer' %}
                            <span class="text-info money-transfer">
                            {{ formatAmountBySymbol(sum.amount*-1, sum.currency_symbol, sum.currency_decimal_places, false) }}
                                {% if convertToPrimary and 0 != sum.pc_amount %}
                                    (~ {{ formatAmountBySymbol(sum.pc_amount*-1, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                                {% endif %}
                                {% if loop.index != group.sums|length %},{% endif %}
                            </span>
                        {% else %}
                            {{ formatAmountBySymbol(sum.amount, sum.currency_symbol, sum.currency_decimal_places) }}
                            {% if convertToPrimary and 0 != sum.pc_amount %}
                                (~ {{ formatAmountBySymbol(sum.pc_amount*-1, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                            {% if loop.index != group.sums|length %},{% endif %}
                        {% endif %}
                    {% endfor %}
                </td>
                <!-- column to span accounts + extra fields -->
                {% if showCategory or showBudget %}
                    <td style="border-top:1px #aaa solid;" colspan="3">&nbsp;</td>
                {% else %}
                    <td style="border-top:1px #aaa solid;" colspan="2">&nbsp;</td>
                {% endif %}
                <td style="border-top:1px #aaa solid;" colspan="2" class="hidden-xs">
                    <div class="btn-group btn-group-xs pull-right">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                            {{ 'actions'|_ }} <span class="caret"></span></button>
                        <ul class="dropdown-menu dropdown-menu-right" role="menu">
                            <li><a href="{{ route('transactions.edit', [group.id]) }}"><span
                                        class="fa fa-fw fa-pencil"></span> {{ 'edit'|_ }}</a></li>
                            <li><a href="{{ route('transactions.delete', [group.id]) }}"><span
                                        class="fa fa-fw fa-trash"></span> {{ 'delete'|_ }}</a></li>
                            <li><a href="#" data-id="{{ group.id }}" class="clone-transaction"><span
                                        class="fa fa-copy fa-fw"></span> {{ 'clone'|_ }}</a></li>
                            <li><a href="#" data-id="{{ group.id }}" class="clone-transaction-and-edit"><span
                                        class="fa fa-copy fa-fw"></span> {{ 'clone_and_edit'|_ }}</a></li>
                        </ul>
                    </div>
                </td>
                <td style="border-top:1px #aaa solid;" class="hidden-xs">&nbsp;</td>
            </tr>
        {% endif %}
        {% for index, transaction in group.transactions %}
            {% set style="" %}
            {% if group.transactions|length == loop.index and group.count > 1 %}
                {% set style="border-bottom:1px #aaa solid;" %}
            {% endif %}
            <tr data-date="{{ transaction.date.format('Y-m-d') }}" data-count="{{ group.count }}"
                data-id="{{ group.id }}">
                <td style=" {{ style|raw }}" class="hidden-xs">
                    {% if transaction.transaction_type_type == 'Withdrawal' %}
                        <span class="fa fa-long-arrow-left fa-fw"
                              title="{{ trans('firefly.Withdrawal') }}"></span>
                    {% endif %}

                    {% if transaction.transaction_type_type == 'Deposit' %}
                        <span class="fa fa-long-arrow-right fa-fw"
                              title="{{ trans('firefly.Deposit') }}"></span>
                    {% endif %}

                    {% if transaction.transaction_type_type == 'Transfer' %}
                        <span class="fa fa-exchange fa-fw" title="{{ trans('firefly.Transfer') }}"></span>
                    {% endif %}

                    {% if transaction.transaction_type_type == 'Reconciliation' %}
                        <span class="fa-fw fa fa-calculator"
                              title="{{ trans('firefly.reconciliation_transaction') }}"></span>
                    {% endif %}
                    {% if transaction.transaction_type_type == 'Opening balance' %}
                        <span class="fa-fw fa fa-star-o"
                              title="{{ trans('firefly.Opening balance') }}"></span>
                    {% endif %}
                    {% if transaction.transaction_type_type == 'Liability credit' %}
                        <span class="fa-fw fa fa-star-o"
                              title="{{ trans('firefly.Liability credit') }}"></span>
                    {% endif %}

                </td>
                <td style=" {{ style|raw }}">
                    {% if transaction.reconciled %}
                        <span class="fa fa-check"></span>
                    {% endif %}
                    {% if transaction.attachments|length > 0 %}
                        <span class="fa fa-paperclip"></span>
                    {% endif %}
                    {% if group.count == 1 %}
                    <a href="{{ route('transactions.show', [group.id]) }}" title="{{ transaction.description }}">
                        {% endif %}
                        {{ transaction.description }}
                        {% if group.count == 1 %}
                    </a>
                    {% endif %}
                </td>
                <td style="{{ style|raw }};text-align:right">

                    {#  deposit #}
                    {% if transaction.transaction_type_type == 'Deposit' %}
                        {# amount of deposit #}
                        {{ formatAmountBySymbol(transaction.amount*-1, transaction.currency_symbol, transaction.currency_decimal_places) }}
                        {# foreign amount of deposit #}
                        {% if null != transaction.foreign_amount %}
                            ({{ formatAmountBySymbol(transaction.foreign_amount*-1, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }})
                        {% endif %}
                        {# primary currency amount of deposit #}
                        {% if convertToPrimary and 0 != transaction.pc_amount %}
                            (~ {{ formatAmountBySymbol(transaction.pc_amount*-1, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                        {% endif %}
                        {# transfer #}
                    {% elseif transaction.transaction_type_type == 'Transfer' %}
                        <span class="text-info money-transfer">
                            {# amount of transfer #}
                            {% if transaction.source_account_id == account.id %}
                                {{ formatAmountBySymbol(transaction.amount, transaction.currency_symbol, transaction.currency_decimal_places, false) }}
                            {% endif %}
                            {% if transaction.source_account_id != account.id %}
                                {{ formatAmountBySymbol(transaction.amount*-1, transaction.currency_symbol, transaction.currency_decimal_places, false) }}
                            {% endif %}

                            {# foreign amount of transfer #}
                            {% if null != transaction.foreign_amount and transaction.source_account_id == account.id %}
                                ({{ formatAmountBySymbol(transaction.foreign_amount, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places, false) }})
                            {% endif %}
                            {% if null != transaction.foreign_amount and transaction.source_account_id != account.id %}
                                ({{ formatAmountBySymbol(transaction.foreign_amount*-1, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places, false) }})
                            {% endif %}

                            {# primary currency amount of transfer #}
                            {% if convertToPrimary and 0 != transaction.pc_amount %}
                                (~ {{ formatAmountBySymbol(transaction.pc_amount*-1, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                            </span>
                        {# opening balance #}
                    {% elseif transaction.transaction_type_type == 'Opening balance' %}
                        {% if transaction.source_account_type == 'Initial balance account' %}
                            {{ formatAmountBySymbol(transaction.amount*-1, transaction.currency_symbol, transaction.currency_decimal_places) }}
                            {% if null != transaction.foreign_amount %}
                                ({{ formatAmountBySymbol(transaction.foreign_amount*-1, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }})
                            {% endif %}
                            {% if convertToPrimary and 0 != transaction.pc_amount %}
                                (~ {{ formatAmountBySymbol(transaction.pc_amount*-1, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                        {% else %}
                            {{ formatAmountBySymbol(transaction.amount, transaction.currency_symbol, transaction.currency_decimal_places) }}
                            {% if null != transaction.foreign_amount %}
                                ({{ formatAmountBySymbol(transaction.foreign_amount, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }})
                            {% endif %}
                            {% if convertToPrimary and 0 != transaction.pc_amount %}
                                (~ {{ formatAmountBySymbol(transaction.pc_amount, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                        {% endif %}
                        {# reconciliation #}
                    {% elseif transaction.transaction_type_type == 'Reconciliation' %}
                        {% if transaction.source_account_type == 'Reconciliation account' %}
                            {{ formatAmountBySymbol(transaction.amount*-1, transaction.currency_symbol, transaction.currency_decimal_places) }}
                            {% if null != transaction.foreign_amount %}
                                ({{ formatAmountBySymbol(transaction.foreign_amount*-1, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }})
                            {% endif %}
                            {% if convertToPrimary and 0 != transaction.pc_amount %}
                                (~ {{ formatAmountBySymbol(transaction.pc_amount*-1, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                        {% else %}
                            {{ formatAmountBySymbol(transaction.amount, transaction.currency_symbol, transaction.currency_decimal_places) }}
                            {% if null != transaction.foreign_amount %}
                                ({{ formatAmountBySymbol(transaction.foreign_amount, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }})
                            {% endif %}
                            {% if convertToPrimary and 0 != transaction.pc_amount %}
                                (~ {{ formatAmountBySymbol(transaction.pc_amount, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                        {% endif %}
                        {# liability credit #}
                    {% elseif transaction.transaction_type_type == 'Liability credit' %}
                        {% if transaction.source_account_type == 'Liability credit' %}
                            {{ formatAmountBySymbol(transaction.amount, transaction.currency_symbol, transaction.currency_decimal_places) }}
                            {% if null != transaction.foreign_amount %}
                                ({{ formatAmountBySymbol(transaction.foreign_amount, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }})
                            {% endif %}
                            {% if convertToPrimary and 0 != transaction.pc_amount %}
                                (~ {{ formatAmountBySymbol(transaction.pc_amount, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                        {% else %}
                            {{ formatAmountBySymbol(transaction.amount*-1, transaction.currency_symbol, transaction.currency_decimal_places) }}
                            {% if null != transaction.foreign_amount %}
                                ({{ formatAmountBySymbol(transaction.foreign_amount*-1, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }})
                            {% endif %}
                            {% if convertToPrimary and 0 != transaction.pc_amount %}
                                (~ {{ formatAmountBySymbol(transaction.pc_amount*-1, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                            {% endif %}
                        {% endif %}


                        {# THE REST #}
                    {% else %}
                        {# amount of withdrawal #}
                        {{ formatAmountBySymbol(transaction.amount, transaction.currency_symbol, transaction.currency_decimal_places) }}

                        {# foreign amount of withdrawal #}
                        {% if null != transaction.foreign_amount %}
                            ({{ formatAmountBySymbol(transaction.foreign_amount, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }})
                        {% endif %}
                        {# primary currency amount of withdrawal, if not in foreign currency #}
                        {% if convertToPrimary and 0 != transaction.pc_amount and primaryCurrency.id != transaction.foreign_currency_id %}
                            (~ {{ formatAmountBySymbol(transaction.pc_amount, primaryCurrency.symbol, primaryCurrency.decimal_places) }})
                        {% endif %}
                    {% endif %}
                </td>
                {% if (fireflyiiiconfig('use_running_balance', true)) %}
                <td style="{{ style|raw }};text-align:right">
                    {# RUNNING BALANCE #}
                    {% if (null == transaction.balance_dirty or false == transaction.balance_dirty) and null != transaction.destination_balance_after and null != transaction.source_balance_after %}
                        {% if transaction.transaction_type_type == 'Deposit' %}
                            {% if transaction.source_account_id == account.id %}
                                <span title="Deposit, source">{{ formatAmountBySymbol(transaction.source_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                            {% else %}
                                <span title="Deposit, dest">{{ formatAmountBySymbol(transaction.destination_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                            {%  endif %}

                        {% elseif transaction.transaction_type_type == 'Withdrawal' %}
                            {# withdrawal into a liability #}
                            {% if 'Loan' == transaction.destination_account_type or 'Mortgage' == transaction.destination_account_type or 'Debt' == transaction.destination_account_type %}
                                {% if currency.id == transaction.currency_id %}
                                    {% if account.id == transaction.source_account_id %}
                                        <span title="Withdrawal, liab, source">{{ formatAmountBySymbol(transaction.source_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                                    {% elseif account.id == transaction.destination_account_id %}
                                        <span title="Withdrawal, liab, dest">{{ formatAmountBySymbol(transaction.destination_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                                    {% else %}
                                        -
                                    {% endif %}
                                {% endif %}
                                {% if currency.id == transaction.foreign_currency_id and null != transaction.destination_balance_after and null != transaction.destination_balance_after %}
                                    <span title="Withdrawal, liab, dest 2">{{ formatAmountBySymbol(transaction.destination_balance_after, transaction.foreign_currency_symbol ?? transaction.currency_symbol, transaction.foreign_currency_decimal_places ?? transaction.currency_decimal_places) }}</span>
                                {% endif %}
                            {# withdrawal into an expense account #}
                            {% else %}
                                {% if account.id == transaction.source_account_id %}
                                    <span title="Withdrawal, source">{{ formatAmountBySymbol(transaction.source_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                                {% elseif account.id == transaction.destination_account_id %}
                                    <span title="Withdrawal, dest">{{ formatAmountBySymbol(transaction.destination_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                                {% else %}
                                    -
                                {% endif %}
                            {% endif %}
                        {% elseif transaction.transaction_type_type == 'Opening balance' %}
                            {% if account.id == transaction.source_account_id %}
                                <span title="Opening balance, src">{{ formatAmountBySymbol(transaction.source_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                            {% elseif account.id == transaction.destination_account_id %}
                                <span title="Opening balance, dest">{{ formatAmountBySymbol(transaction.destination_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                            {% else %}
                                -
                            {% endif %}
                        {% elseif transaction.transaction_type_type == 'Transfer' %}
                            {% if account.id == transaction.source_account_id %}
                                <span title="Transfer, source">{{ formatAmountBySymbol(transaction.source_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                            {% else %}
                                {% if null == transaction.foreign_currency_id %}
                                    <span title="Transfer, dest, normal currency">{{ formatAmountBySymbol(transaction.destination_balance_after, transaction.currency_symbol, transaction.currency_decimal_places) }}</span>
                                {% endif %}
                                {% if null != transaction.foreign_currency_id %}
                                    <span title="Transfer, dest, foreign currency">{{ formatAmountBySymbol(transaction.destination_balance_after, transaction.foreign_currency_symbol, transaction.foreign_currency_decimal_places) }}</span>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            &nbsp;
                        {% endif %}
                    {% endif %}
                </td>
                {% endif %}
                <td style=" {{ style|raw }}">
                    {{ transaction.date.isoFormat(monthAndDayFormat) }}
                </td>
                <td style=" {{ style|raw }}">
                    {% if 'Cash account' == transaction.source_account_type %}
                        <span class="text-success">({{ 'cash'|_ }})</span>
                    {% else %}
                        <a href="{{ route('accounts.show', [transaction.source_account_id|default(1)]) }}"
                           title="{{ transaction.source_account_iban|default(transaction.source_account_name) }}">{{ transaction.source_account_name }}</a>
                    {% endif %}
                </td>
                <td style=" {{ style|raw }}">
                    {% if 'Cash account' == transaction.destination_account_type %}
                        <span class="text-success">({{ 'cash'|_ }})</span>
                    {% else %}
                        <a href="{{ route('accounts.show', [transaction.destination_account_id|default(1)]) }}"
                           title="{{ transaction.destination_account_iban|default(transaction.destination_account_name) }}">{{ transaction.destination_account_name }}</a>
                    {% endif %}
                </td>
                {% if showCategory %}
                    <td style=" {{ style|raw }}" class="hidden-xs">
                        {% if transaction.category_id %}
                            <a href="{{ route('categories.show', [transaction.category_id]) }}"
                               title="{{ transaction.category_name }}">{{ transaction.category_name }}</a>
                        {% endif %}
                    </td>
                {% endif %}
                {% if showBudget %}
                    <td style=" {{ style|raw }}" class="hidden-xs">
                        {% if transaction.budget_id %}
                            <a href="{{ route('budgets.show', [transaction.budget_id]) }}"
                               title="{{ transaction.budget_name }}">{{ transaction.budget_name }}</a>
                        {% endif %}
                    </td>
                {% endif %}

                {% if group.count == 1 %}
                    <td style=" {{ style|raw }};" class="hidden-xs">
                        <div class="btn-group btn-group-xs pull-right">
                            <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                                    aria-haspopup="true" aria-expanded="false">
                                {{ 'actions'|_ }} <span class="caret"></span></button>
                            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                                <li><a href="{{ route('transactions.edit', [group.id]) }}"><span
                                            class="fa fa-fw fa-pencil"></span> {{ 'edit'|_ }}</a></li>
                                {% if transaction.transaction_type_type != 'Opening balance' and transaction.transaction_type_type != 'Liability credit' %}
                                <li><a href="{{ route('transactions.delete', [group.id]) }}"><span
                                            class="fa fa-fw fa-trash"></span> {{ 'delete'|_ }}</a></li>
                                {% endif %}
                                {% if transaction.transaction_type_type != 'Reconciliation' and transaction.transaction_type_type != 'Opening balance' and transaction.transaction_type_type != 'Liability credit' %}
                                <li><a href="#" data-id="{{ group.id }}" class="clone-transaction"><span
                                            class="fa fa-copy fa-fw"></span> {{ 'clone'|_ }}</a></li>
                                <li><a href="#" data-id="{{ group.id }}" class="clone-transaction-and-edit"><span
                                            class="fa fa-copy fa-fw"></span> {{ 'clone_and_edit'|_ }}</a></li>
                                <li>
                                    <a href="{{ route('rules.create-from-journal', [transaction.transaction_journal_id]) }}"><span
                                            class="fa fa-fw fa-random"></span> {{ 'create_rule_from_transaction'|_ }}
                                    </a></li>
                                {% endif %}
                            </ul>
                        </div>
                    </td>

                {% endif %}
                {% if group.count != 1 %}
                    <td style=" {{ style|raw }};" class="hidden-xs">
                        &nbsp;
                    </td>
                {% endif %}
                <td style="{{ style|raw }}" class="hidden-xs">
                    {% if transaction.transaction_type_type != 'Reconciliation' and transaction.transaction_type_type != 'Opening balance' and transaction.transaction_type_type != 'Liability credit' %}
                    <div class="pull-right">
                        <input id="list_{{ transaction.transaction_journal_id }}"
                               value="{{ transaction.transaction_journal_id }}"
                               name="journals[{{ transaction.transaction_journal_id }}]"
                               type="checkbox" class="mass-select form-check-inline"
                               data-value="{{ transaction.transaction_journal_id }}"/>
                        {% endif %}
                    </div>
                </td>
            </tr>
        {% endfor %}
    {% endfor %}
    </tbody>
    <tfoot>
    {% set pageSums = {} %}
    {% for group in groups %}
        {% for transaction in group.transactions %}
            {% set displayAmount = transaction.amount %}
            {% if transaction.transaction_type_type == 'Deposit' or transaction.transaction_type_type == 'Transfer' %}
                {% set displayAmount = transaction.amount * -1 %}
            {% elseif transaction.transaction_type_type == 'Opening balance' or transaction.transaction_type_type == 'Reconciliation' %}
                {% if transaction.source_account_type == 'Initial balance account' or transaction.source_account_type == 'Reconciliation account' %}
                    {% set displayAmount = transaction.amount * -1 %}
                {% endif %}
            {% elseif transaction.transaction_type_type == 'Liability credit' %}
                {% if transaction.source_account_type != 'Liability credit' %}
                    {% set displayAmount = transaction.amount * -1 %}
                {% endif %}
            {% endif %}
            {% set sumKey = transaction.currency_symbol ~ '||' ~ transaction.currency_decimal_places %}
            {% set pageSums = pageSums|merge({(sumKey): (pageSums[sumKey]|default(0)) + displayAmount}) %}
        {% endfor %}
    {% endfor %}
    {% if pageSums|length > 0 %}
    <tr style="border-top:2px solid rgba(128,128,128,0.4);">
        <td class="hidden-xs">&nbsp;</td>
        <td><strong>Page Total</strong></td>
        <td style="text-align:right">
            <strong>
            {% for sumKey, total in pageSums %}
                {% set parts = sumKey|split('||') %}
                {{ formatAmountBySymbol(total, parts[0], parts[1]) }}{% if not loop.last %}<br>{% endif %}
            {% endfor %}
            </strong>
        </td>
        {% if fireflyiiiconfig('use_running_balance', true) %}
        <td>&nbsp;</td>
        {% endif %}
        <td colspan="{{ (showCategory|default(false) or showBudget|default(false)) ? 5 : 4 }}">&nbsp;</td>
        <td class="hidden-xs">&nbsp;</td>
    </tr>
    {% endif %}
    <tr>
        <td colspan="8">
            <div class="pull-right">
                <!-- Single button -->
                <div class="btn-group action-menu btn-group-xs pull-right" style="display:none;">
                    <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                        {{ 'actions'|_ }} <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu btn-group-xs dropdown-menu-right">
                        <li><a href="#" class="mass-edit"><span class="fa fa-fw fa-pencil"></span>
                                <span>{{ 'mass_edit'|_ }}</span></a></li>
                        <li><a href="#" class="bulk-edit"><span class="fa fa-fw fa-pencil-square-o"></span>
                                <span>{{ 'bulk_edit'|_ }}</span></a></li>
                        <li><a href="#" class="mass-delete"><span class="fa fa-fw fa-trash"></span>
                                <span>{{ 'mass_delete'|_ }}</span></a></li>
                    </ul>
                </div>
            </div>
        </td>
    </tr>
    <tr>
        {% if showCategory or showBudget %}
            <td colspan="9" class="no-margin-pagination">
                {{ groups.links('pagination.bootstrap-4')|raw }}
                {% if groups.total() > 0 %}
                    <span class="text-muted small" style="margin-left:10px;">Showing {{ groups.firstItem() }}–{{ groups.lastItem() }} of {{ groups.total() }}</span>
                    {% include 'partials.per-page-toggle' %}
                {% endif %}
            </td>
        {% else %}
            <td colspan="8" class="no-margin-pagination">
                {{ groups.links('pagination.bootstrap-4')|raw }}
                {% if groups.total() > 0 %}
                    <span class="text-muted small" style="margin-left:10px;">Showing {{ groups.firstItem() }}–{{ groups.lastItem() }} of {{ groups.total() }}</span>
                    {% include 'partials.per-page-toggle' %}
                {% endif %}
            </td>
        {% endif %}
    </tr>
    </tfoot>
</table>

<div class="modal fade" id="filterHelpModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title"><span class="fa fa-question-circle"></span> Advanced Filter Reference</h4>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                <p class="text-muted">
                    Type operators in the search box as <code>operator:value</code>.
                    Combine multiple with spaces. Negate with <code>-operator:value</code>.
                    Quote values with spaces: <code>description_contains:"online purchase"</code>.
                </p>

                <h4 style="margin-top:0;"><span class="fa fa-font fa-fw"></span> Description &amp; Notes</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:20px;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>description_contains:text</code></td><td>Description contains text</td></tr>
                        <tr><td><code>description_is:text</code></td><td>Description exactly equals</td></tr>
                        <tr><td><code>description_starts:text</code></td><td>Description starts with</td></tr>
                        <tr><td><code>description_ends:text</code></td><td>Description ends with</td></tr>
                        <tr><td><code>notes_contains:text</code></td><td>Notes contain text</td></tr>
                        <tr><td><code>notes_is:text</code></td><td>Notes exactly equal</td></tr>
                    </tbody>
                </table>

                <h4><span class="fa fa-calculator fa-fw"></span> Amounts</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:20px;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>amount_more:100</code></td><td>Amount greater than (alias: <code>more</code>)</td></tr>
                        <tr><td><code>amount_less:500</code></td><td>Amount less than (alias: <code>less</code>)</td></tr>
                        <tr><td><code>amount_is:49.99</code></td><td>Amount exactly equals (alias: <code>amount</code>)</td></tr>
                        <tr><td><code>foreign_amount_more:100</code></td><td>Foreign amount greater than</td></tr>
                        <tr><td><code>foreign_amount_less:500</code></td><td>Foreign amount less than</td></tr>
                    </tbody>
                </table>

                <h4><span class="fa fa-calendar fa-fw"></span> Dates</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:20px;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>date_after:2026-01-01</code></td><td>After date (alias: <code>after</code>)</td></tr>
                        <tr><td><code>date_before:2026-12-31</code></td><td>Before date (alias: <code>before</code>)</td></tr>
                        <tr><td><code>date_on:2026-02-25</code></td><td>On exact date (alias: <code>on</code>, <code>date</code>)</td></tr>
                        <tr><td><code>created_at_after:2026-01-01</code></td><td>Created after date</td></tr>
                        <tr><td><code>updated_at_after:2026-01-01</code></td><td>Updated after date</td></tr>
                        <tr><td colspan="2" class="text-muted small">Also: <code>book_date_*</code>, <code>interest_date_*</code>, <code>process_date_*</code>, <code>due_date_*</code>, <code>payment_date_*</code>, <code>invoice_date_*</code></td></tr>
                    </tbody>
                </table>

                <h4><span class="fa fa-university fa-fw"></span> Accounts</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:20px;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>source_account_contains:text</code></td><td>Source account name contains (alias: <code>source</code>, <code>from</code>)</td></tr>
                        <tr><td><code>source_account_is:text</code></td><td>Source account name equals</td></tr>
                        <tr><td><code>destination_account_contains:text</code></td><td>Destination account contains (alias: <code>destination</code>, <code>to</code>)</td></tr>
                        <tr><td><code>destination_account_is:text</code></td><td>Destination account equals</td></tr>
                        <tr><td><code>account_id:123</code></td><td>Either account has this ID</td></tr>
                        <tr><td><code>source_account_id:123</code></td><td>Source account ID</td></tr>
                        <tr><td><code>destination_account_id:123</code></td><td>Destination account ID</td></tr>
                        <tr><td><code>source_is_cash</code></td><td>Source is cash account</td></tr>
                        <tr><td><code>destination_is_cash</code></td><td>Destination is cash account</td></tr>
                        <tr><td colspan="2" class="text-muted small">Also: <code>*_starts</code>, <code>*_ends</code>, <code>*_nr_is</code>, <code>*_nr_contains</code> variants for account names &amp; numbers</td></tr>
                    </tbody>
                </table>

                <h4><span class="fa fa-pie-chart fa-fw"></span> Category, Budget &amp; Bill</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:20px;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>category_contains:text</code></td><td>Category contains (alias: <code>category</code>)</td></tr>
                        <tr><td><code>category_is:text</code></td><td>Category exactly equals</td></tr>
                        <tr><td><code>budget_contains:text</code></td><td>Budget contains (alias: <code>budget</code>)</td></tr>
                        <tr><td><code>budget_is:text</code></td><td>Budget exactly equals</td></tr>
                        <tr><td><code>bill_contains:text</code></td><td>Bill/subscription contains (alias: <code>bill</code>)</td></tr>
                        <tr><td><code>bill_is:text</code></td><td>Bill/subscription exactly equals</td></tr>
                        <tr><td colspan="2" class="text-muted small">Also: <code>*_starts</code>, <code>*_ends</code> variants</td></tr>
                    </tbody>
                </table>

                <h4><span class="fa fa-tag fa-fw"></span> Tags</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:20px;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>tag_is:text</code></td><td>Has this exact tag (alias: <code>tag</code>)</td></tr>
                        <tr><td><code>tag_is_not:text</code></td><td>Does not have this tag</td></tr>
                        <tr><td><code>tag_contains:text</code></td><td>Has a tag containing text</td></tr>
                    </tbody>
                </table>

                <h4><span class="fa fa-check-square-o fa-fw"></span> Presence Checks</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:20px;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>has_attachments</code></td><td>Has attachments</td></tr>
                        <tr><td><code>has_no_attachments</code></td><td>No attachments</td></tr>
                        <tr><td><code>has_any_category</code></td><td>Has a category</td></tr>
                        <tr><td><code>has_no_category</code></td><td>No category set</td></tr>
                        <tr><td><code>has_any_budget</code></td><td>Has a budget</td></tr>
                        <tr><td><code>has_no_budget</code></td><td>No budget set</td></tr>
                        <tr><td><code>has_any_bill</code></td><td>Linked to a bill</td></tr>
                        <tr><td><code>has_no_bill</code></td><td>Not linked to any bill</td></tr>
                        <tr><td><code>has_any_tag</code></td><td>Has at least one tag</td></tr>
                        <tr><td><code>has_no_tag</code></td><td>No tags</td></tr>
                        <tr><td><code>any_notes</code></td><td>Has notes</td></tr>
                        <tr><td><code>no_notes</code></td><td>No notes</td></tr>
                        <tr><td><code>reconciled</code></td><td>Is reconciled</td></tr>
                    </tbody>
                </table>

                <h4><span class="fa fa-exchange fa-fw"></span> Transaction Type &amp; IDs</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:20px;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>transaction_type:withdrawal</code></td><td>Filter by type (alias: <code>type</code>)</td></tr>
                        <tr><td><code>id:123</code></td><td>Transaction group ID</td></tr>
                        <tr><td><code>journal_id:456</code></td><td>Transaction journal ID</td></tr>
                        <tr><td><code>currency_is:EUR</code></td><td>Transaction currency</td></tr>
                        <tr><td><code>foreign_currency_is:USD</code></td><td>Foreign currency</td></tr>
                    </tbody>
                </table>

                <h4><span class="fa fa-link fa-fw"></span> External References</h4>
                <table class="table table-condensed table-striped" style="margin-bottom:0;">
                    <thead><tr><th style="width:40%;">Operator</th><th>What it does</th></tr></thead>
                    <tbody>
                        <tr><td><code>external_id_contains:text</code></td><td>External ID contains</td></tr>
                        <tr><td><code>internal_reference_contains:text</code></td><td>Internal reference contains</td></tr>
                        <tr><td><code>external_url_contains:text</code></td><td>External URL contains</td></tr>
                        <tr><td><code>attachment_name_contains:text</code></td><td>Attachment name contains</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" nonce="{{ JS_NONCE }}">
    var cloneGroupUrl = '{{ route('transactions.clone') }}';
    var cloneAndEditUrl = '{{ route('transactions.clone') }}?redirect=edit';

    var filterParamNames = [
        'filter_description', 'filter_amount_min', 'filter_amount_max',
        'filter_date_from', 'filter_date_to', 'filter_source',
        'filter_destination', 'filter_category', 'filter_budget', 'filter_query'
    ];

    function ffApplyFilters() {
        var url = new URL(window.location.href);
        url.searchParams.delete('page');
        for (var i = 0; i < filterParamNames.length; i++) {
            var el = document.getElementById(filterParamNames[i]);
            var val = el ? el.value.trim() : '';
            if (val !== '') {
                url.searchParams.set(filterParamNames[i], val);
            } else {
                url.searchParams.delete(filterParamNames[i]);
            }
        }
        window.location.href = url.toString();
    }

    function ffClearFilters() {
        var url = new URL(window.location.href);
        for (var i = 0; i < filterParamNames.length; i++) {
            url.searchParams.delete(filterParamNames[i]);
        }
        url.searchParams.delete('page');
        window.location.href = url.toString();
    }

    (function () {
        var filterRows = document.querySelectorAll('.filter-row');
        var filtersVisible = localStorage.getItem('ff_filters_visible') === 'true';
        var hasActiveFilters = false;

        for (var i = 0; i < filterParamNames.length; i++) {
            var el = document.getElementById(filterParamNames[i]);
            if (el && el.value && el.value.trim() !== '') {
                hasActiveFilters = true;
                break;
            }
        }

        if (hasActiveFilters || filtersVisible) {
            for (var j = 0; j < filterRows.length; j++) {
                filterRows[j].style.display = '';
            }
            localStorage.setItem('ff_filters_visible', 'true');
        }

        document.getElementById('toggle-filters').addEventListener('click', function () {
            var rows = document.querySelectorAll('.filter-row');
            var visible = rows.length > 0 && rows[0].style.display !== 'none';
            for (var k = 0; k < rows.length; k++) {
                rows[k].style.display = visible ? 'none' : '';
            }
            localStorage.setItem('ff_filters_visible', visible ? 'false' : 'true');
        });

        document.getElementById('apply-filters').addEventListener('click', ffApplyFilters);
        document.getElementById('clear-filters').addEventListener('click', ffClearFilters);

        var inputs = document.querySelectorAll('.filter-input, #filter_query');
        for (var m = 0; m < inputs.length; m++) {
            inputs[m].addEventListener('keypress', function (e) {
                if (e.which === 13 || e.keyCode === 13) {
                    e.preventDefault();
                    ffApplyFilters();
                }
            });
        }
    })();
</script>
